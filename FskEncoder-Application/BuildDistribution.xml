<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<project default="build distribution" name="Build Distribution">

	<property name="app.root" location="H:/GitRepository/FskEncoder-Application/FskEncoder-Application"/>
	<property name="ext.root" location="H:/GitRepository/FskEncoder-Extensions/FskEncoder-Extensions"/>
	<property name="dir.dist"	value="H:/GitSandbox/FskEncoder/dist" />
	<property name="target"		value="FskEncoder-all-dist.zip" />

	
	<include file="${app.root}/ApplicationBuildSupport.xml" />
	<include file="${ext.root}/ExtensionsBuildSupport.xml" />

	
	<taskdef resource="net/sf/antcontrib/antlib.xml">
	  <classpath>
	    <pathelement location="C:/Users/Stefan/.p2/pool/plugins/ant-contrib-1.0b3-bin/ant-contrib/ant-contrib-1.0b3.jar"/>
	  </classpath>
	</taskdef>
	

	<target name="build distribution" description="">
		
		<antcall target="clean" />
		<antcall target="pack distri" />
		
	</target>
	
	
	<target name="clean" description="Deletes ALL files and folders in the 'dist' directory" >
		
		<delete>
			<fileset dir="${dir.dist}" includes="*.zip" />
		</delete>
				
		<renewDir candidate="bin" />
		<renewDir candidate="cfg" />
		<renewDir candidate="extensions" />
		<renewDir candidate="lib" />
		
	</target>
	
	
	<target name="pack distri" depends="bild all" description="Packes all files and folders in a ZIP container. Depends on 'build all'">
		
		<delete file="${dir.dist}/${target}" failonerror="no" />
		
		<move 
			file="${dir.dist}/bin/FskEncoder-all.bat" 
			tofile="${dir.dist}/bin/FskEncoder.bat" 
			overwrite="yes" 
			failonerror="no" 
			verbose="true"
		/>
		
		<zip destfile="${dir.dist}/${target}"
			basedir="${dir.dist}"
			excludes="*.zip cfg/Empty.properties cfg/*Extension.properties bin/*Extension.bat"
		/>
		
	</target>
	
	
	<target name="bild all" description="Build the main application and all extensions" >
		
		<tstamp>
			<format property="current.time" pattern="yyyy.MM.dd HH:mm:ss" />
		</tstamp>

		<echo message="Build Application: ${current.time}" />      
		
		<ant antfile="${app.root}/BuildApplication.xml" target="Build Application"/>
		
		
		<tstamp>
			<format property="current.time" pattern="yyyy.MM.dd HH:mm:ss" />
		</tstamp>

		<echo message="Build Extensions: ${current.time}" />      
		
		<ant antfile="${ext.root}/BuildExtensions.xml" target="Build Extensions"/>

	</target>

	
	<macrodef name="renewDir">
		<attribute name="candidate"/>
		
		<sequential>
			
			<echo message="candidate = ${dir.dist}/@{candidate}" />
		
	        <delete dir="${dir.dist}/@{candidate}" failonerror="no" />
	        <mkdir dir="${dir.dist}/@{candidate}"/>
			
		</sequential>
		
	</macrodef>


</project>
